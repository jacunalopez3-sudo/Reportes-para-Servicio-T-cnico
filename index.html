<!-- ===================== index.html ===================== -->
function fileToDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }


/******************** Fecha/hora ********************/
function pad2(n){return (n<10?'0':'')+n} function initFechaHora(){ const d = new Date(); document.getElementById('fecha').value = d.toISOString().slice(0,10); document.getElementById('hora').value = pad2(d.getHours())+":"+pad2(d.getMinutes()); } initFechaHora();


/******************** Guardar reporte ********************/
function formDataToObj(){ const get = id => document.getElementById(id).value.trim(); const firma = signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png'); const id = `${Date.now()}-${Math.random().toString(36).slice(2,7)}`; return { id, fecha: get('fecha'), hora: get('hora'), cliente: get('cliente'), responsable: get('responsable'), correo: get('correo'), marca: get('marca'), modelo: get('modelo'), serie: get('serie'), falla: get('falla'), acciones: get('acciones'), repuestos: get('repuestos'), horas: get('horas'), estado: get('estado'), fotos: fotosDataURLs, logo: logoDataURL, firma }; }
async function guardarLocal(){ const obj = formDataToObj(); await dbPut(obj); renderTabla(); toast('Guardado localmente'); }
document.getElementById('guardar').addEventListener('click', guardarLocal);


/******************** Render tabla ********************/
async function renderTabla(){ const tbody = document.getElementById('tabla'); const datos = await dbGetAll(); datos.sort((a,b)=> (b.fecha+b.hora).localeCompare(a.fecha+a.hora)); tbody.innerHTML = ''; for (const r of datos){ const tr = document.createElement('tr'); tr.innerHTML = `<td class="nowrap">${r.fecha} ${r.hora}</td><td>${escapeHTML(r.cliente)}</td><td>${escapeHTML(r.marca)} ${escapeHTML(r.modelo)} <span class="muted">#${escapeHTML(r.serie)}</span></td><td class="right"><button class="btn" data-act="pdf" data-id="${r.id}">PDF</button><button class="btn" data-act="view" data-id="${r.id}">Cargar</button><button class="btn" data-act="del" data-id="${r.id}">Borrar</button></td>`; tbody.appendChild(tr); }
tbody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async ev => { const id = ev.currentTarget.dataset.id; const act = ev.currentTarget.dataset.act; const all = await dbGetAll(); const r = all.find(x=>x.id===id); if (!r) return; if (act==='del') { await dbDelete(id); renderTabla(); toast('Eliminado'); return; } if (act==='view') { loadToForm(r); toast('Reporte cargado en el formulario'); return; } if (act==='pdf') { generarPDF(r); return; } })); }


function loadToForm(r){ document.getElementById('fecha').value = r.fecha; document.getElementById('hora').value = r.hora; document.getElementById('cliente').value = r.cliente; document.getElementById('responsable').value = r.responsable; document.getElementById('correo').value = r.correo || ''; document.getElementById('marca').value = r.marca; document.getElementById('modelo').value = r.modelo; document.getElementById('serie').value = r.serie; document.getElementById('falla').value = r.falla; document.getElementById('acciones').value = r.acciones; document.getElementById('repuestos').value = r.repuestos || ''; document.getElementById('horas').value = r.horas || ''; document.getElementById('estado').value = r.estado || 'Operativo'; fotosDataURLs = r.fotos || []; thumbs.innerHTML = ''; for (const url of fotosDataURLs){ const img = document.createElement('img'); img.src = url; thumbs.appendChild(img); } logoDataURL = r.logo || null; signaturePad.clear(); if (r.firma){ const img = new Image(); img.onload = ()=>{ const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); }; img.src = r.firma; } }


function escapeHTML(str=''){ return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }


/******************** PDF ********************/
async function generarPDF(sourceObj){ const obj = sourceObj || formDataToObj(); const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt', format:'a4'}); const M = 48; let y = M; if (obj.logo){ try { doc.addImage(obj.logo, 'PNG', M, y, 90, 42); } catch(e) {} } doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('REPORTE DE SERVICIO TÉCNICO – EQUIPOS MÉDICOS', M + (obj.logo? 100:0), y+20); doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(120,140,170); doc.text(`Fecha: ${obj.fecha} Hora: ${obj.hora}`, M, y+60); y += 78; doc.setTextColor(30,40,60); y = writeBlock(doc, 'Cliente / Sitio', [['Cliente', obj.cliente],['Responsable en sitio', obj.responsable],['Correo', obj.correo || '-']], M, y); y = writeBlock(doc, 'Equipo', [['Marca', obj.marca],['Modelo', obj.modelo],['N° Serie', obj.serie],['Estado final', obj.estado]], M, y); y = writeMultiline(doc, 'Descripción de falla / solicitud', obj.falla, M, y); y = writeMultiline(doc, 'Acciones realizadas / diagnóstico', obj.acciones, M, y); y = writeBlock(doc, 'Recursos', [['Repuestos', obj.repuestos || '-'],['Horas trabajadas', obj.horas || '-']], M, y); if (obj.fotos && obj.fotos.length){ doc.setFont('helvetica','bold'); doc.setFontSize(12); y = ensurePage(doc, y, 24, M); doc.text('Evidencia fotográfica', M, y); y += 10; const W = 240, H = 160, GAP = 20; for (let i=0;i<obj.fotos.length;i++){ if (i%2===0) { y = ensurePage(doc, y, H+GAP, M); } const x = M + (i%2)*(W+GAP); try { doc.addImage(obj.fotos[i], 'JPEG', x, y, W, H); } catch(e) {} if (i%2===1) y += H + GAP; } if (obj.fotos.length%2===1) y += H + GAP; }
doc.setFont('helvetica','bold'); doc.setFontSize(12); y = ensurePage(doc, y, 120, M); doc.text('Firma del cliente / conformidad', M, y); if (obj.firma){ try { doc.addImage(obj.firma, 'PNG', M, y+10, 240, 80); } catch(e) {} } doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(`${obj.cliente} – ${obj.responsable}`, M, y+100); doc.setDrawColor(200,210,230); doc.line(M, 800, 595-M, 800); doc.setFontSize(8); doc.setTextColor(120,140,170); doc.text('Generado con app local (PWA) – Funciona offline. ©', M, 812); const nombre = `Reporte_${obj.fecha}_${(obj.cliente||'Cliente').replace(/[^a-z0-9\-_]+/gi,'_')}.pdf`; doc.save(nombre); }


function writeBlock(doc, title, pairs, M, y){ doc.setFont('helvetica','bold'); doc.setFontSize(12); y = ensurePage(doc, y, 18 + pairs.length*16, M); doc.text(title, M, y); y += 8; doc.setFont('helvetica','normal'); doc.setFontSize(10); const colW = 150; pairs.forEach(([k,v]) => { y += 14; doc.text(`${k}:`, M, y); doc.text(String(v||'-'), M+colW, y); }); y += 10; return y; }
function writeMultiline(doc, title, text, M, y){ doc.setFont('helvetica','bold'); doc.setFontSize(12); const lines = doc.splitTextToSize(String(text||'-'), 595 - 2*M); y = ensurePage(doc, y, 24 + lines.length*12, M); doc.text(title, M, y); y += 12; doc.setFont('helvetica','normal'); doc.setFontSize(10); lines.forEach(line => { y += 12; doc.text(line, M, y); }); y += 10; return y; }
function ensurePage(doc, y, needed, M){ const H = doc.internal.pageSize.getHeight(); if (y + needed > H - 60) { doc.addPage(); return 48; } return y; }


/******************** Exportar / Importar ********************/
document.getElementById('exportarTodo').addEventListener('click', async ()=>{ const datos = await dbGetAll(); const blob = new Blob([JSON.stringify(datos, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reportes_backup.json'; a.click(); });
document.getElementById('importarBtn').addEventListener('click', ()=> document.getElementById('importarInput').click());
document.getElementById('importarInput').addEventListener('change', async ev =>{ const file = ev.target.files?.[0]; if (!file) return; const text = await file.text(); try { const arr = JSON.parse(text); for (const r of arr) await dbPut(r); renderTabla(); toast('Importado'); } catch(e){ alert('Archivo inválido'); } });


/******************** Botón PDF directo del form ********************/
document.getElementById('pdf').addEventListener('click', ()=> generarPDF());


/******************** Toaster ********************/
function toast(msg){ const d = document.createElement('div'); d.textContent = msg; d.style.cssText = 'position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#101a35;border:1px solid #253055;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:9999;color:#ebf0ff;'; document.body.appendChild(d); setTimeout(()=> d.remove(), 2200); }


/******************** Service Worker (externo) ********************/
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('./sw.js?v=3')
.then(()=>{ const el = document.getElementById('estadoOffline'); if (el) el.textContent = '✅ Offline listo'; })
.catch(()=>{ const el = document.getElementById('estadoOffline'); if (el) el.textContent = '⚠️ Offline no disponible'; });
} else {
const el = document.getElementById('estadoOffline'); if (el) el.textContent = '⚠️ Navegador sin Service Worker';
}


// Render inicial tabla
renderTabla();
</script>
</body>
</html>
